<!DOCTYPE html>
    <html>
        <head>
            <meta charset="UTF-8" />
            <title>Geosoftware I - Uebung 4</title>
            <!--Route-->
            <script type="text/javascript" src="data/route.geojson"></script> 
            <!--Functions-->
            <script type="text/javascript" src="lib/uebung_4.js"></script> 
            <!--Style-->
            <script type="text/javascript" src="lib/jQuerry_3_6_0.js"></script> 
            <!--Leaflet-->
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""/>
            <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
            <!--Leaflet Draw-->
            <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.4.10/leaflet.draw.css' rel='stylesheet' />
            <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.4.10/leaflet.draw.js'></script>
            <!--jQuery-->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
            <!--Open Weather API Key-->
            <script type="text/javascript" src="data/api_keys.js"></script> 

            <style type="text/css">
                #mapdiv {height : 600px; width : 600px; z-index: 1;}
                #resetButton {position: relative; z-index: 100;}
            </style>
        </head>
        <body>
            <div id ="mapWrapper">
                <div id="mapdiv"></div>
                <div></div>
                <input type="button" id="resetButton" value="reset intersections" onclick="resetMap()">
            </div>
            
            <script>
                var map = L.map('mapdiv'); //Map Object

                //Basemap Layer
                var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href = "http://osm.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(map); 

                //Route layer
                var routeLayer = L.geoJSON(route).addTo(map);
                //Fit Bounds to the Route
                map.fitBounds(routeLayer.getBounds());

                //Feature Group Layer for the Input Feature from leaflet.draw
                var rectangleLayer = L.featureGroup().addTo(map);
                var markerLayer = L.featureGroup().addTo(map);

                //Layer Control
                //Overlays
				var overlayMaps = { 
					"Route": routeLayer,
                    "Rectangle": rectangleLayer,
                    "Markers": markerLayer
				}; 
                //Basemaps
				var baseMaps = {
					"OSM": osm
				}; 
				L.control.layers(baseMaps, overlayMaps).addTo(map);

                //Draw Control
                var drawControl = new L.Control.Draw({
                    draw: {
                        polyline: false,
                        polygon: false,
                        circle: false,
                        marker: false
                    },
                    edit: {
                        featureGroup: rectangleLayer
                    }
                }).addTo(map);

                var inputRectangle;
                var inputRectangleArray = [];
                var inputRectangleGeoJSON;
                var intersections = [];

                map.on('draw:created', function(e) {
                    rectangleLayer.addLayer(e.layer);
                    var inputRectangle = e.layer._latlngs[0];
                    for(i = 0; i < inputRectangle.length; i++) {
                        inputRectangleArray.push([inputRectangle[i].lat, inputRectangle[i].lng]);
                    };
                    
                    inputRectangleArray.push(inputRectangleArray[0]);
                    inputRectangleArray = convertToLonLat(inputRectangleArray);
                    inputRectangleGeoJSON = arrayToGeoJson(inputRectangleArray);
                    intersections = getAllIntersections(route.features[0].geometry.coordinates[0], inputRectangleGeoJSON.coordinates[0]);

                    for(i = 0; i < intersections.length; i++) {
                        var marker = new L.Marker([intersections[i][1], intersections[i][0]]);
                        marker.addTo(map);
                        markerLayer.addLayer(marker);
                        weatherRequest([intersections[i][0], intersections[i][1]], openweather, marker);
                    };
                });
            </script>
        </body>
</html> 